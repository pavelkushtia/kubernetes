<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TweetStream - Social Media Platform</title>
    <style>
        /* TweetStream Frontend Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #15202b;
            color: #ffffff;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid #38444d;
        }

        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .connection-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .connection-status.connected {
            background: rgba(29, 161, 242, 0.1);
            color: #1da1f2;
            border: 1px solid #1da1f2;
        }

        .connection-status.disconnected {
            background: rgba(255, 173, 31, 0.1);
            color: #ffad1f;
            border: 1px solid #ffad1f;
        }

        .connection-status.error {
            background: rgba(249, 24, 128, 0.1);
            color: #f91880;
            border: 1px solid #f91880;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            color: #1da1f2;
            font-size: 2.5em;
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1da1f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .auth-section {
            background: #192734;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid #38444d;
            max-width: 400px;
            margin: 50px auto;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: #8899a6;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .auth-tab.active {
            color: #1da1f2;
            border-bottom-color: #1da1f2;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #38444d;
            border-radius: 8px;
            background: #0f1419;
            color: #ffffff;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #1da1f2;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            margin-top: 20px;
        }

        .feed-section {
            background: #192734;
            border-radius: 15px;
            border: 1px solid #38444d;
        }

        .sidebar {
            background: #192734;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #38444d;
            height: fit-content;
        }

        .compose-tweet {
            padding: 20px;
            border-bottom: 1px solid #38444d;
        }

        .compose-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 1px solid #38444d;
            border-radius: 10px;
            background: #0f1419;
            color: #ffffff;
            font-size: 16px;
            resize: vertical;
            font-family: inherit;
        }

        .compose-textarea:focus {
            outline: none;
            border-color: #1da1f2;
        }

        .compose-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .char-count {
            color: #8899a6;
            font-size: 14px;
        }

        .char-count.warning {
            color: #ffad1f;
        }

        .char-count.error {
            color: #f91880;
        }

        .button {
            display: inline-block;
            background: #1da1f2;
            color: white;
            padding: 12px 20px;
            margin: 5px;
            text-decoration: none;
            border-radius: 25px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            font-size: 14px;
            font-weight: bold;
        }

        .button:hover {
            background: #1991db;
        }

        .button:disabled {
            background: #38444d;
            cursor: not-allowed;
        }

        .button.secondary {
            background: transparent;
            border: 1px solid #38444d;
            color: #ffffff;
        }

        .button.secondary:hover {
            background: #38444d;
        }

        .button.danger {
            background: #f91880;
        }

        .button.danger:hover {
            background: #e1156f;
        }

        .tweet {
            padding: 20px;
            border-bottom: 1px solid #38444d;
            transition: background 0.3s;
        }

        .tweet:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .tweet-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tweet-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #1da1f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .tweet-user-info {
            flex: 1;
        }

        .tweet-user-name {
            color: #ffffff;
            font-weight: bold;
            margin-right: 5px;
        }

        .tweet-username {
            color: #8899a6;
            font-size: 14px;
        }

        .tweet-time {
            color: #8899a6;
            font-size: 14px;
        }

        .tweet-content {
            color: #ffffff;
            margin: 15px 0;
            font-size: 16px;
            line-height: 1.5;
        }

        .tweet-actions {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .tweet-action {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #8899a6;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 20px;
            transition: all 0.3s;
            font-size: 14px;
        }

        .tweet-action:hover {
            background: rgba(29, 161, 242, 0.1);
            color: #1da1f2;
        }

        .tweet-action.liked {
            color: #f91880;
        }

        .tweet-action.retweeted {
            color: #17bf63;
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #38444d;
            transition: background 0.3s;
        }

        .user-card:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .user-card:last-child {
            border-bottom: none;
        }

        .user-card-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #1da1f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-card-info {
            flex: 1;
        }

        .user-card-name {
            color: #ffffff;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .user-card-username {
            color: #8899a6;
            font-size: 14px;
        }

        .follow-btn {
            padding: 6px 16px;
            font-size: 12px;
            border-radius: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #0f1419;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #38444d;
        }

        .stat-number {
            font-size: 1.5em;
            color: #1da1f2;
            font-weight: bold;
        }

        .stat-label {
            color: #8899a6;
            margin-top: 5px;
            font-size: 12px;
        }

        .section-title {
            color: #ffffff;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #38444d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8899a6;
        }

        .error {
            background: #f91880;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .success {
            background: #17bf63;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .hidden {
            display: none !important;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #192734;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #38444d;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                order: -1;
            }
            
            .stats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .tweet-actions {
                gap: 10px;
            }
            
            .tweet-action {
                padding: 6px 8px;
                font-size: 12px;
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .notification.info {
            background: #1da1f2;
        }

        .notification.success {
            background: #17bf63;
        }

        .notification.warning {
            background: #ffad1f;
        }

        .notification.error {
            background: #f91880;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <h1>üê¶ TweetStream</h1>
                <span style="color: #8899a6;">Social Media Platform</span>
            </div>
            <div class="header-center">
                <div class="connection-status" id="connectionStatus">üî¥ Offline</div>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">User</span>
                <button class="button secondary" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Authentication Section -->
        <div class="auth-section" id="authSection">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchTab('login')">Login</button>
                <button class="auth-tab" onclick="switchTab('register')">Register</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">Username or Email</label>
                    <input type="text" id="loginUsername" placeholder="Enter username or email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password">
                </div>
                <button class="button" onclick="login()" style="width: 100%;">Login</button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label for="registerUsername">Username</label>
                    <input type="text" id="registerUsername" placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="registerDisplayName">Display Name</label>
                    <input type="text" id="registerDisplayName" placeholder="Your display name">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" placeholder="Choose a password (min 6 chars)">
                </div>
                <button class="button" onclick="register()" style="width: 100%;">Register</button>
            </div>

            <div id="authMessage"></div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent" style="display: none;">
            <!-- Feed Section -->
            <div class="feed-section">
                <!-- Compose Tweet -->
                <div class="compose-tweet">
                    <textarea 
                        class="compose-textarea" 
                        id="tweetContent" 
                        placeholder="What's happening?"
                        maxlength="280"
                        oninput="updateCharCount()"
                    ></textarea>
                    <div class="compose-actions">
                        <span class="char-count" id="charCount">0/280</span>
                        <button class="button" id="tweetBtn" onclick="postTweet()">Tweet</button>
                    </div>
                </div>

                <!-- Feed -->
                <div id="tweetFeed">
                    <div class="loading">Loading tweets...</div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Stats -->
                <div class="stats" id="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="usersCount">0</div>
                        <div class="stat-label">Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="tweetsCount">0</div>
                        <div class="stat-label">Tweets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="likesCount">0</div>
                        <div class="stat-label">Likes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="followsCount">0</div>
                        <div class="stat-label">Follows</div>
                    </div>
                </div>

                <!-- Suggested Users -->
                <div>
                    <div class="section-title">Suggested Users</div>
                    <div id="suggestedUsers">
                        <div class="loading">Loading users...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="userModal" class="modal hidden">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="modalUserName">User Profile</h2>
                <button class="button secondary" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalUserContent">
                <!-- User profile content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let authToken = null;
        let tweets = [];
        let users = [];

        // Configuration
        const API_BASE = '/api';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('TweetStream frontend loaded successfully!');
            
            // Check for stored auth token
            const storedToken = localStorage.getItem('tweetstream_token');
            if (storedToken) {
                authToken = storedToken;
                verifyToken();
            }
            
            // Load initial data
            loadStats();
            
            // Set up periodic updates
            setInterval(loadStats, 30000); // Update stats every 30 seconds
        });

        // Authentication functions
        function switchTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const tabs = document.querySelectorAll('.auth-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                tabs[0].classList.add('active');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                tabs[1].classList.add('active');
            }
            
            clearAuthMessage();
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showAuthMessage('Please fill in all fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('tweetstream_token', authToken);
                    showAuthMessage('Login successful!', 'success');
                    setTimeout(() => {
                        showMainApp();
                    }, 1000);
                } else {
                    showAuthMessage(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showAuthMessage('Network error. Please try again.', 'error');
                console.error('Login error:', error);
            }
        }

        async function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const displayName = document.getElementById('registerDisplayName').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!username || !email || !password) {
                showAuthMessage('Please fill in all required fields', 'error');
                return;
            }

            if (password.length < 6) {
                showAuthMessage('Password must be at least 6 characters', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password, display_name: displayName })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('tweetstream_token', authToken);
                    showAuthMessage('Registration successful!', 'success');
                    setTimeout(() => {
                        showMainApp();
                    }, 1000);
                } else {
                    showAuthMessage(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showAuthMessage('Network error. Please try again.', 'error');
                console.error('Registration error:', error);
            }
        }

        async function verifyToken() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.user;
                    showMainApp();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('tweetstream_token');
            showAuthSection();
        }

        function showAuthMessage(message, type) {
            const messageDiv = document.getElementById('authMessage');
            messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function clearAuthMessage() {
            document.getElementById('authMessage').innerHTML = '';
        }

        function showMainApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'grid';
            document.getElementById('userInfo').style.display = 'flex';
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.display_name || currentUser.username;
            document.getElementById('userAvatar').textContent = (currentUser.display_name || currentUser.username).charAt(0).toUpperCase();
            
            // Load main content
            loadTweets();
            loadSuggestedUsers();
        }

        function showAuthSection() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            clearAuthMessage();
        }

        // Tweet functions
        function updateCharCount() {
            const textarea = document.getElementById('tweetContent');
            const charCount = document.getElementById('charCount');
            const tweetBtn = document.getElementById('tweetBtn');
            
            const length = textarea.value.length;
            charCount.textContent = `${length}/280`;
            
            if (length > 280) {
                charCount.classList.add('error');
                tweetBtn.disabled = true;
            } else if (length > 250) {
                charCount.classList.remove('error');
                charCount.classList.add('warning');
                tweetBtn.disabled = false;
            } else {
                charCount.classList.remove('error', 'warning');
                tweetBtn.disabled = length === 0;
            }
        }

        async function postTweet() {
            const content = document.getElementById('tweetContent').value.trim();
            
            if (!content || content.length > 280) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tweets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('tweetContent').value = '';
                    updateCharCount();
                    loadTweets(); // Refresh feed
                    loadStats(); // Update stats
                } else {
                    alert('Failed to post tweet: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Network error. Please try again.');
                console.error('Post tweet error:', error);
            }
        }

        async function loadTweets() {
            try {
                const response = await fetch(`${API_BASE}/tweets`, {
                    headers: authToken ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {}
                });

                const data = await response.json();

                if (data.success) {
                    tweets = data.tweets;
                    renderTweets();
                } else {
                    document.getElementById('tweetFeed').innerHTML = '<div class="error">Failed to load tweets</div>';
                }
            } catch (error) {
                document.getElementById('tweetFeed').innerHTML = '<div class="error">Network error loading tweets</div>';
                console.error('Load tweets error:', error);
            }
        }

        function renderTweets() {
            const feedDiv = document.getElementById('tweetFeed');
            
            if (tweets.length === 0) {
                feedDiv.innerHTML = '<div class="loading">No tweets yet. Be the first to tweet!</div>';
                return;
            }

            const tweetsHtml = tweets.map(tweet => `
                <div class="tweet">
                    <div class="tweet-header">
                        <div class="tweet-avatar">${(tweet.display_name || tweet.username).charAt(0).toUpperCase()}</div>
                        <div class="tweet-user-info">
                            <span class="tweet-user-name">${tweet.display_name || tweet.username}</span>
                            ${tweet.is_verified ? '‚úÖ' : ''}
                            <span class="tweet-username">@${tweet.username}</span>
                            <span class="tweet-time">‚Ä¢ ${formatTime(tweet.created_at)}</span>
                        </div>
                    </div>
                    <div class="tweet-content">${escapeHtml(tweet.content)}</div>
                    <div class="tweet-actions">
                        <div class="tweet-action ${tweet.is_liked ? 'liked' : ''}" onclick="toggleLike(${tweet.id})">
                            ‚ù§Ô∏è ${tweet.likes_count || 0}
                        </div>
                        <div class="tweet-action ${tweet.is_retweeted ? 'retweeted' : ''}" onclick="toggleRetweet(${tweet.id})">
                            üîÑ ${tweet.retweets_count || 0}
                        </div>
                        <div class="tweet-action" onclick="showUserProfile(${tweet.user_id})">
                            üë§ Profile
                        </div>
                        ${tweet.user_id === currentUser?.id ? `<div class="tweet-action" onclick="deleteTweet(${tweet.id})" style="color: #f91880;">üóëÔ∏è Delete</div>` : ''}
                    </div>
                </div>
            `).join('');

            feedDiv.innerHTML = tweetsHtml;
        }

        async function toggleLike(tweetId) {
            if (!authToken) {
                alert('Please login to like tweets');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tweets/${tweetId}/like`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Update local tweet data
                    const tweet = tweets.find(t => t.id === tweetId);
                    if (tweet) {
                        tweet.is_liked = data.is_liked;
                        tweet.likes_count = data.likes_count;
                        renderTweets();
                    }
                }
            } catch (error) {
                console.error('Toggle like error:', error);
            }
        }

        async function toggleRetweet(tweetId) {
            if (!authToken) {
                alert('Please login to retweet');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tweets/${tweetId}/retweet`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Update local tweet data
                    const tweet = tweets.find(t => t.id === tweetId);
                    if (tweet) {
                        tweet.is_retweeted = data.is_retweeted;
                        tweet.retweets_count = data.retweets_count;
                        renderTweets();
                    }
                }
            } catch (error) {
                console.error('Toggle retweet error:', error);
            }
        }

        async function deleteTweet(tweetId) {
            if (!confirm('Are you sure you want to delete this tweet?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tweets/${tweetId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    loadTweets(); // Refresh feed
                    loadStats(); // Update stats
                } else {
                    alert('Failed to delete tweet');
                }
            } catch (error) {
                alert('Network error. Please try again.');
                console.error('Delete tweet error:', error);
            }
        }

        // User functions
        async function loadSuggestedUsers() {
            try {
                const response = await fetch(`${API_BASE}/users?limit=5`);
                const data = await response.json();

                if (data.success) {
                    users = data.users;
                    renderSuggestedUsers();
                } else {
                    document.getElementById('suggestedUsers').innerHTML = '<div class="error">Failed to load users</div>';
                }
            } catch (error) {
                document.getElementById('suggestedUsers').innerHTML = '<div class="error">Network error loading users</div>';
                console.error('Load users error:', error);
            }
        }

        function renderSuggestedUsers() {
            const usersDiv = document.getElementById('suggestedUsers');
            
            if (users.length === 0) {
                usersDiv.innerHTML = '<div class="loading">No users found</div>';
                return;
            }

            const usersHtml = users.slice(0, 5).map(user => `
                <div class="user-card">
                    <div class="user-card-avatar">${(user.display_name || user.username).charAt(0).toUpperCase()}</div>
                    <div class="user-card-info">
                        <div class="user-card-name">${user.display_name || user.username} ${user.is_verified ? '‚úÖ' : ''}</div>
                        <div class="user-card-username">@${user.username}</div>
                    </div>
                    <button class="button follow-btn ${user.is_following ? 'secondary' : ''}" onclick="toggleFollow(${user.id})">
                        ${user.is_following ? 'Unfollow' : 'Follow'}
                    </button>
                </div>
            `).join('');

            usersDiv.innerHTML = usersHtml;
        }

        async function toggleFollow(userId) {
            if (!authToken) {
                alert('Please login to follow users');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/users/${userId}/follow`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Update local user data
                    const user = users.find(u => u.id === userId);
                    if (user) {
                        user.is_following = data.is_following;
                        user.followers_count = data.followers_count;
                        renderSuggestedUsers();
                    }
                    loadStats(); // Update follow count
                }
            } catch (error) {
                console.error('Toggle follow error:', error);
            }
        }

        async function showUserProfile(userId) {
            // This would open a modal with user profile details
            // For now, just show an alert
            alert(`User profile feature coming soon! User ID: ${userId}`);
        }

        // Stats functions
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('usersCount').textContent = data.stats.total_users;
                    document.getElementById('tweetsCount').textContent = data.stats.total_tweets;
                    document.getElementById('likesCount').textContent = data.stats.total_likes;
                    document.getElementById('followsCount').textContent = data.stats.total_follows;
                }
            } catch (error) {
                console.error('Load stats error:', error);
            }
        }

        // Utility functions
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'now';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            if (days < 7) return `${days}d`;
            
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function closeModal() {
            document.getElementById('userModal').classList.add('hidden');
        }

        // WebSocket functionality for real-time updates
        let socket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function initWebSocket() {
            try {
                // Connect to WebSocket server
                socket = io(window.location.origin, {
                    transports: ['websocket', 'polling'],
                    timeout: 20000,
                    forceNew: true
                });

                socket.on('connect', () => {
                    console.log('WebSocket connected');
                    reconnectAttempts = 0;
                    
                    // Authenticate if user is logged in
                    if (authToken) {
                        socket.emit('authenticate', authToken);
                        socket.emit('join_feed');
                    }
                    
                    showConnectionStatus('connected');
                });

                socket.on('authenticated', (data) => {
                    if (data.success) {
                        console.log('WebSocket authenticated for user:', data.userId);
                    } else {
                        console.error('WebSocket authentication failed:', data.error);
                    }
                });

                socket.on('disconnect', () => {
                    console.log('WebSocket disconnected');
                    showConnectionStatus('disconnected');
                    
                    // Attempt to reconnect
                    if (reconnectAttempts < maxReconnectAttempts) {
                        setTimeout(() => {
                            reconnectAttempts++;
                            console.log(`Reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                            initWebSocket();
                        }, 2000 * reconnectAttempts);
                    }
                });

                // Real-time tweet events
                socket.on('new_tweet', (tweet) => {
                    console.log('New tweet received:', tweet);
                    // Add new tweet to the beginning of the feed
                    tweets.unshift(tweet);
                    renderTweets();
                    loadStats(); // Update stats
                    showNotification('New tweet posted!', 'info');
                });

                socket.on('follower_tweet', (tweet) => {
                    console.log('Follower tweet received:', tweet);
                    // Add follower's tweet with special styling
                    tweets.unshift(tweet);
                    renderTweets();
                    showNotification(`New tweet from @${tweet.username}`, 'info');
                });

                socket.on('tweet_updated', (data) => {
                    console.log('Tweet updated:', data);
                    // Update specific tweet in the feed
                    const tweet = tweets.find(t => t.id === data.tweet_id);
                    if (tweet) {
                        if (data.type === 'tweet_liked' || data.type === 'tweet_unliked') {
                            tweet.likes_count = data.likes_count;
                        } else if (data.type === 'tweet_retweeted' || data.type === 'tweet_unretweeted') {
                            tweet.retweets_count = data.retweets_count;
                        }
                        renderTweets();
                    }
                });

                // Real-time follow events
                socket.on('follower_update', (data) => {
                    console.log('Follower update:', data);
                    if (data.type === 'user_followed') {
                        showNotification('You have a new follower!', 'success');
                    }
                    loadStats(); // Update follower count
                });

                socket.on('following_update', (data) => {
                    console.log('Following update:', data);
                    loadSuggestedUsers(); // Refresh suggested users
                });

                socket.on('like_update', (data) => {
                    console.log('Like update:', data);
                    // Real-time like animation could be added here
                });

                socket.on('new_user', (user) => {
                    console.log('New user registered:', user);
                    loadSuggestedUsers(); // Refresh suggested users
                    loadStats(); // Update user count
                });

                socket.on('connect_error', (error) => {
                    console.error('WebSocket connection error:', error);
                    showConnectionStatus('error');
                });

            } catch (error) {
                console.error('WebSocket initialization error:', error);
                showConnectionStatus('error');
            }
        }

        function showConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            if (!statusElement) return;

            statusElement.className = `connection-status ${status}`;
            switch (status) {
                case 'connected':
                    statusElement.textContent = 'üü¢ Live';
                    statusElement.title = 'Real-time updates active';
                    break;
                case 'disconnected':
                    statusElement.textContent = 'üü° Reconnecting...';
                    statusElement.title = 'Attempting to reconnect';
                    break;
                case 'error':
                    statusElement.textContent = 'üî¥ Offline';
                    statusElement.title = 'Real-time updates unavailable';
                    break;
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Enhanced authentication to include WebSocket
        function enhancedShowMainApp() {
            showMainApp();
            
            // Initialize WebSocket connection
            if (!socket || socket.disconnected) {
                initWebSocket();
            } else if (authToken) {
                socket.emit('authenticate', authToken);
                socket.emit('join_feed');
            }
        }

        function enhancedLogout() {
            // Disconnect WebSocket
            if (socket) {
                socket.emit('leave_feed');
                socket.disconnect();
                socket = null;
            }
            logout();
        }

        // Override original functions
        const originalShowMainApp = showMainApp;
        const originalLogout = logout;
        showMainApp = enhancedShowMainApp;
        logout = enhancedLogout;

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to tweet
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const tweetContent = document.getElementById('tweetContent');
                if (document.activeElement === tweetContent && tweetContent.value.trim()) {
                    postTweet();
                }
            }
        });
    </script>
    
    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</body>
</html> 