---
# TweetStream Grafana Dashboard Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: tweetstream-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  tweetstream-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "TweetStream - Twitter Clone Monitoring",
        "tags": ["tweetstream", "social-media", "twitter-clone"],
        "style": "dark",
        "timezone": "browser",
        "refresh": "30s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "üìä Application Overview",
            "type": "stat",
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "tweetstream_active_users_total",
                "legendFormat": "Active Users",
                "refId": "A"
              },
              {
                "expr": "increase(tweetstream_tweets_total[1h])",
                "legendFormat": "Tweets (1h)",
                "refId": "B"
              },
              {
                "expr": "increase(tweetstream_likes_total[1h])",
                "legendFormat": "Likes (1h)",
                "refId": "C"
              },
              {
                "expr": "sum(up{job=\"tweetstream-api\"})",
                "legendFormat": "API Instances",
                "refId": "D"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "palette-classic"},
                "custom": {
                  "displayMode": "list",
                  "orientation": "horizontal"
                },
                "mappings": [],
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "red", "value": 80}
                  ]
                }
              }
            },
            "options": {
              "reduceOptions": {
                "values": false,
                "calcs": ["lastNotNull"],
                "fields": ""
              },
              "orientation": "auto",
              "textMode": "auto",
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto"
            }
          },
          {
            "id": 2,
            "title": "üê¶ Tweet Activity Over Time",
            "type": "graph",
            "gridPos": {"h": 9, "w": 12, "x": 0, "y": 8},
            "targets": [
              {
                "expr": "rate(tweetstream_tweets_total[5m]) * 60",
                "legendFormat": "Tweets per minute",
                "refId": "A"
              },
              {
                "expr": "rate(tweetstream_likes_total[5m]) * 60",
                "legendFormat": "Likes per minute",
                "refId": "B"
              }
            ],
            "yAxes": [
              {
                "label": "Rate per minute",
                "show": true
              },
              {
                "show": true
              }
            ],
            "xAxis": {
              "show": true
            },
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "points": false,
            "pointradius": 2,
            "bars": false,
            "stack": false,
            "percentage": false,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": true,
              "total": false,
              "values": false
            },
            "nullPointMode": "null"
          },
          {
            "id": 3,
            "title": "üë• Active Users Trend",
            "type": "graph",
            "gridPos": {"h": 9, "w": 12, "x": 12, "y": 8},
            "targets": [
              {
                "expr": "tweetstream_active_users_total",
                "legendFormat": "Active Users",
                "refId": "A"
              }
            ],
            "yAxes": [
              {
                "label": "Users",
                "show": true
              },
              {
                "show": true
              }
            ],
            "xAxis": {
              "show": true
            },
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "points": false,
            "pointradius": 2,
            "bars": false,
            "stack": false,
            "percentage": false,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": true,
              "total": false,
              "values": false
            },
            "nullPointMode": "null"
          },
          {
            "id": 4,
            "title": "üöÄ API Performance",
            "type": "graph",
            "gridPos": {"h": 9, "w": 12, "x": 0, "y": 17},
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job=\"tweetstream-api\"}[5m]))",
                "legendFormat": "95th percentile",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket{job=\"tweetstream-api\"}[5m]))",
                "legendFormat": "50th percentile",
                "refId": "B"
              },
              {
                "expr": "rate(http_request_duration_seconds_sum{job=\"tweetstream-api\"}[5m]) / rate(http_request_duration_seconds_count{job=\"tweetstream-api\"}[5m])",
                "legendFormat": "Average",
                "refId": "C"
              }
            ],
            "yAxes": [
              {
                "label": "Response Time (seconds)",
                "show": true
              },
              {
                "show": true
              }
            ],
            "xAxis": {
              "show": true
            },
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "points": false,
            "pointradius": 2,
            "bars": false,
            "stack": false,
            "percentage": false,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": true,
              "total": false,
              "values": false
            },
            "nullPointMode": "null"
          },
          {
            "id": 5,
            "title": "üìà HTTP Request Rate",
            "type": "graph",
            "gridPos": {"h": 9, "w": 12, "x": 12, "y": 17},
            "targets": [
              {
                "expr": "sum(rate(http_request_duration_seconds_count{job=\"tweetstream-api\"}[5m])) by (method)",
                "legendFormat": "{{method}} requests/sec",
                "refId": "A"
              }
            ],
            "yAxes": [
              {
                "label": "Requests per second",
                "show": true
              },
              {
                "show": true
              }
            ],
            "xAxis": {
              "show": true
            },
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "points": false,
            "pointradius": 2,
            "bars": false,
            "stack": false,
            "percentage": false,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": true,
              "total": false,
              "values": false
            },
            "nullPointMode": "null"
          },
          {
            "id": 6,
            "title": "üíæ Resource Usage - CPU",
            "type": "graph",
            "gridPos": {"h": 9, "w": 12, "x": 0, "y": 26},
            "targets": [
              {
                "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"tweetstream\"}[5m])) by (pod)",
                "legendFormat": "{{pod}}",
                "refId": "A"
              }
            ],
            "yAxes": [
              {
                "label": "CPU Usage (cores)",
                "show": true
              },
              {
                "show": true
              }
            ],
            "xAxis": {
              "show": true
            },
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "points": false,
            "pointradius": 2,
            "bars": false,
            "stack": false,
            "percentage": false,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": true,
              "total": false,
              "values": false
            },
            "nullPointMode": "null"
          },
          {
            "id": 7,
            "title": "üíæ Resource Usage - Memory",
            "type": "graph",
            "gridPos": {"h": 9, "w": 12, "x": 12, "y": 26},
            "targets": [
              {
                "expr": "sum(container_memory_usage_bytes{namespace=\"tweetstream\"}) by (pod) / 1024 / 1024",
                "legendFormat": "{{pod}} MB",
                "refId": "A"
              }
            ],
            "yAxes": [
              {
                "label": "Memory Usage (MB)",
                "show": true
              },
              {
                "show": true
              }
            ],
            "xAxis": {
              "show": true
            },
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "points": false,
            "pointradius": 2,
            "bars": false,
            "stack": false,
            "percentage": false,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": true,
              "total": false,
              "values": false
            },
            "nullPointMode": "null"
          },
          {
            "id": 8,
            "title": "üóÑÔ∏è Database Connections",
            "type": "graph",
            "gridPos": {"h": 9, "w": 12, "x": 0, "y": 35},
            "targets": [
              {
                "expr": "pg_stat_database_numbackends{datname=\"tweetstream\"}",
                "legendFormat": "Active Connections",
                "refId": "A"
              }
            ],
            "yAxes": [
              {
                "label": "Connections",
                "show": true
              },
              {
                "show": true
              }
            ],
            "xAxis": {
              "show": true
            },
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "points": false,
            "pointradius": 2,
            "bars": false,
            "stack": false,
            "percentage": false,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": true,
              "total": false,
              "values": false
            },
            "nullPointMode": "null"
          },
          {
            "id": 9,
            "title": "üîÑ Redis Cache Performance",
            "type": "graph",
            "gridPos": {"h": 9, "w": 12, "x": 12, "y": 35},
            "targets": [
              {
                "expr": "rate(redis_commands_processed_total[5m])",
                "legendFormat": "Commands/sec",
                "refId": "A"
              },
              {
                "expr": "redis_connected_clients",
                "legendFormat": "Connected Clients",
                "refId": "B"
              }
            ],
            "yAxes": [
              {
                "label": "Rate",
                "show": true
              },
              {
                "show": true
              }
            ],
            "xAxis": {
              "show": true
            },
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "points": false,
            "pointradius": 2,
            "bars": false,
            "stack": false,
            "percentage": false,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": true,
              "total": false,
              "values": false
            },
            "nullPointMode": "null"
          },
          {
            "id": 10,
            "title": "üì° Kafka Message Throughput",
            "type": "graph",
            "gridPos": {"h": 9, "w": 12, "x": 0, "y": 44},
            "targets": [
              {
                "expr": "rate(kafka_server_brokertopicmetrics_messagesin_total[5m])",
                "legendFormat": "Messages In/sec",
                "refId": "A"
              },
              {
                "expr": "rate(kafka_server_brokertopicmetrics_bytesout_total[5m])",
                "legendFormat": "Bytes Out/sec",
                "refId": "B"
              }
            ],
            "yAxes": [
              {
                "label": "Rate",
                "show": true
              },
              {
                "show": true
              }
            ],
            "xAxis": {
              "show": true
            },
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "points": false,
            "pointradius": 2,
            "bars": false,
            "stack": false,
            "percentage": false,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": true,
              "total": false,
              "values": false
            },
            "nullPointMode": "null"
          },
          {
            "id": 11,
            "title": "üåê Network I/O",
            "type": "graph",
            "gridPos": {"h": 9, "w": 12, "x": 12, "y": 44},
            "targets": [
              {
                "expr": "sum(rate(container_network_receive_bytes_total{namespace=\"tweetstream\"}[5m])) by (pod)",
                "legendFormat": "{{pod}} RX",
                "refId": "A"
              },
              {
                "expr": "sum(rate(container_network_transmit_bytes_total{namespace=\"tweetstream\"}[5m])) by (pod)",
                "legendFormat": "{{pod}} TX",
                "refId": "B"
              }
            ],
            "yAxes": [
              {
                "label": "Bytes per second",
                "show": true
              },
              {
                "show": true
              }
            ],
            "xAxis": {
              "show": true
            },
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "points": false,
            "pointradius": 2,
            "bars": false,
            "stack": false,
            "percentage": false,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": true,
              "total": false,
              "values": false
            },
            "nullPointMode": "null"
          },
          {
            "id": 12,
            "title": "‚ö° Pod Status & Health",
            "type": "table",
            "gridPos": {"h": 9, "w": 24, "x": 0, "y": 53},
            "targets": [
              {
                "expr": "kube_pod_info{namespace=\"tweetstream\"}",
                "legendFormat": "{{pod}}",
                "refId": "A",
                "format": "table"
              },
              {
                "expr": "kube_pod_status_phase{namespace=\"tweetstream\"}",
                "legendFormat": "{{pod}} - {{phase}}",
                "refId": "B",
                "format": "table"
              }
            ],
            "styles": [
              {
                "alias": "Pod",
                "colorMode": null,
                "colors": ["rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)"],
                "dateFormat": "YYYY-MM-DD HH:mm:ss",
                "decimals": 2,
                "mappingType": 1,
                "pattern": "pod",
                "thresholds": [],
                "type": "string",
                "unit": "short"
              },
              {
                "alias": "Status",
                "colorMode": "cell",
                "colors": ["rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)"],
                "dateFormat": "YYYY-MM-DD HH:mm:ss",
                "decimals": 2,
                "mappingType": 1,
                "pattern": "phase",
                "thresholds": ["1", "2"],
                "type": "string",
                "unit": "short"
              }
            ]
          }
        ],
        "schemaVersion": 27,
        "version": 1,
        "links": []
      }
    }

---
# Prometheus Rules for TweetStream Alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: tweetstream-alerts
  namespace: monitoring
  labels:
    app: tweetstream
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
  - name: tweetstream.rules
    rules:
    - alert: TweetStreamAPIDown
      expr: up{job="tweetstream-api"} == 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "TweetStream API is down"
        description: "TweetStream API has been down for more than 1 minute."
    
    - alert: TweetStreamHighResponseTime
      expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="tweetstream-api"}[5m])) > 2
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "TweetStream API high response time"
        description: "TweetStream API 95th percentile response time is above 2 seconds."
    
    - alert: TweetStreamHighErrorRate
      expr: rate(http_request_duration_seconds_count{job="tweetstream-api",status_code=~"5.."}[5m]) / rate(http_request_duration_seconds_count{job="tweetstream-api"}[5m]) > 0.1
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "TweetStream API high error rate"
        description: "TweetStream API error rate is above 10%."
    
    - alert: TweetStreamDatabaseDown
      expr: up{job="postgres-exporter"} == 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "TweetStream database is down"
        description: "PostgreSQL database for TweetStream is not responding."
    
    - alert: TweetStreamRedisDown
      expr: up{job="redis-exporter"} == 0
      for: 1m
      labels:
        severity: warning
      annotations:
        summary: "TweetStream Redis cache is down"
        description: "Redis cache for TweetStream is not responding."
    
    - alert: TweetStreamKafkaDown
      expr: up{job="kafka-exporter"} == 0
      for: 1m
      labels:
        severity: warning
      annotations:
        summary: "TweetStream Kafka is down"
        description: "Kafka message broker for TweetStream is not responding."
    
    - alert: TweetStreamHighMemoryUsage
      expr: container_memory_usage_bytes{namespace="tweetstream"} / container_spec_memory_limit_bytes{namespace="tweetstream"} > 0.9
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "TweetStream high memory usage"
        description: "TweetStream pod {{$labels.pod}} memory usage is above 90%."
    
    - alert: TweetStreamHighCPUUsage
      expr: rate(container_cpu_usage_seconds_total{namespace="tweetstream"}[5m]) / container_spec_cpu_quota{namespace="tweetstream"} * container_spec_cpu_period{namespace="tweetstream"} > 0.8
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "TweetStream high CPU usage"
        description: "TweetStream pod {{$labels.pod}} CPU usage is above 80%." 